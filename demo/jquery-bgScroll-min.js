/*
 * Background Scroll - jQuery plugin for parallax like background scrolling
 *
 * Copyright (c) 2013 Shane Donnelly
 *
 * Licensed under the MIT license:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Project home:
 * http://shanejdonnelly.github.io/background-scroll*
 * Version:  1.0
 *
 */
;(function(e,t,n,r){function o(t,n){this.element=t;this.settings=e.extend({},s,n);this._defaults=s;this._name=i;this.init(this.settings.first_image,this.settings.first_section)}var i="bgScroll",s={wrap_div:"#wrapper",first_section:0,spacer_height:"auto",images:true,images_src:["http://lorempixel.com/1500/723/nature/","http://lorempixel.com/1500/723/abstract/","http://lorempixel.com/1500/723/sports/","http://lorempixel.com/1500/723/nightlife/"],tag_name:"section",analytics:false,img_height:723,img_width:1500,first_image:"http://lorempixel.com/1500/723/nature/"};o.prototype={init:function(n,r){var i=this,s=e(this.settings.wrap_div);s.css("visibility","hidden");e(this.settings.tag_name).each(function(t){var n=e('<div class="bg_wrap" id="bg_wrap_'+t+'" style="width:100%; top:0; left:0; z-index:'+(t+1)*-1+'; overflow:hidden;">'),r=e('<img src="'+i.settings.images_src[t]+'" class="bg" id="bg_'+t+'" style="position:relative; z-index:'+(t+1)*-1+';  display:block;"/>'),s=e('<div class="top-spacer"></div>'),o=e('<div class="marker top-marker">&nbsp;</div>'),u=e('<div class="bottom-spacer" style="height:1px;"></div>'),a=e('<div class="marker bottom-marker" style="height:1px;">&nbsp;</div>');e(this).prepend(o).prepend(s);e(this).append(a).append(u);n.append(r);e(this).after(n)});this.cacheElements();this.current_section=parseInt(r);this.prev_section=this.current_section!==0?this.current_section-1:this.current_section;this.next_section=this.current_section+1;this.$current_section=e(this.settings.tag_name).eq(this.current_section);e("<img/>").attr("src",n).load(function(){e(this).remove();i.$bg_images.eq(i.current_section).css("position","fixed");i.$bg_images.eq(i.next_section).css("position","fixed");i.sizeStuff();setTimeout(function(){if(i.current_section==0){t.scrollTo(0,0)}else{var n=i.$sections.eq(i.current_section).offset().top;e("html,body").animate({scrollTop:n+i.win_height*.8},50)}s.css("visibility","visible");e("#loader").hide();i.events();i.start_scroll_pos=i.$window.scrollTop();i.scroll_pos;if(i.settings.analytics){i.trackPageview()}},1500)})},cacheElements:function(){this.$window=e(t);this.$bg_wraps=e(".bg_wrap");this.$bg_images=e(".bg");this.$top_spacers=e(".top-spacer");this.$bottom_spacers=e(".bottom-spacer");this.$sections=e(this.settings.tag_name);this.win_height=this.$window.height();this.win_width=this.$window.width()},changeSection:function(e){var t=this.$bg_images.eq(this.current_section).add(this.$bg_images.eq(this.prev_section)).add(this.$bg_images.eq(this.next_section)),n=this.$sections.eq(this.current_section).add(this.$sections.eq(this.prev_section)).add(this.$sections.eq(this.next_section)),r=this.$bg_images.not(t),i=this.$sections.not(n);if(e==="down"){this.$current_section=this.$sections.eq(this.current_section);t.css("visibility","visible");n.css("visibility","visible");this.$bg_images.eq(this.current_section).css("position","fixed");this.$bg_images.eq(this.prev_section).css("position","relative");this.$bg_images.eq(this.next_section).css("position","fixed");r.css("visibility","hidden");i.css("visibility","hidden")}else{this.$current_section=this.$sections.eq(this.current_section);t.css("visibility","visible");n.css("visibility","visible");this.$bg_images.eq(this.current_section).css({position:"fixed"});this.$bg_images.eq(this.next_section);r.css("visibility","hidden");i.css("visibility","hidden")}if(this.settings.analytics){base.trackPageview()}},findCurrentSection:function(t){var n=e(this.settings.tag_name+":in-viewport"),r=this.$sections.index(n),i=this;if(this.current_section!==r&&r!==-1){this.current_section=r;this.next_section=r+1;this.prev_section=r-1;this.changeSection(t)}},events:function(){function n(){t.scroll_pos=t.$window.scrollTop();if(t.scrollingDown()){if(!t.$current_section.find(".bottom-marker").is(":in-viewport")&&t.current_section<t.$sections.length-1){t.findCurrentSection("down")}}else{if(!t.$current_section.find(".top-spacer").is(":in-viewport")&&t.current_section>0){t.findCurrentSection("up")}}}var t=this;this.$window.on("resize",function(){t.sizeStuff()});this.$window.on("scroll",n);this.$window.on("touchmove",n);e("#scroll-down-btn").on("click",function(){var n=t.$sections.eq(t.next_section).offset().top;if(Modernizr.touch){e("body").animate({scrollTop:n+t.win_height*.9},50)}else{e("html, body").animate({scrollTop:n+t.win_height*.9},1750)}})},scrollingDown:function(){var e=this.scroll_pos,t=e>this.start_scroll_pos?true:false;this.start_scroll_pos=e;return t},sizeStuff:function(){var e=this,t=this.settings.img_height,n=this.settings.img_width,r=e.$window.width(),i=e.$window.height(),s=this.settings.spacer_height!=="auto"?this.settings.spacer_height:this.win_height,o=r/n,u=i/t,a=0,f=0;this.win_height=i;this.win_width=r;this.$top_spacers.height(s);this.$bg_wraps.height(this.win_height);this.$bg_images.css("height",i);f=n*u;this.$bg_images.css("width",f);left=(f-r)/2;this.$bg_images.css("left","-"+left+"px")},trackPageView:function(){_gaq.push(["_trackPageview",this.current_chapter+"/"+this.current_section])}};e.fn[i]=function(t){return this.each(function(){if(!e.data(this,"plugin_"+i)){e.data(this,"plugin_"+i,new o(this,t))}})}})(jQuery,window,document)
